name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
      - '**-dev'
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # PROJECT DETECTION
  # ============================================================================
  
  detect-project:
    name: Detect Project Type
    runs-on: ubuntu-latest
    outputs:
      has-nodejs: ${{ steps.detect.outputs.has-nodejs }}
      has-python: ${{ steps.detect.outputs.has-python }}
      has-docker: ${{ steps.detect.outputs.has-docker }}
      has-tests: ${{ steps.detect.outputs.has-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect project technologies
        id: detect
        run: |
          echo "ðŸ” Detecting project technologies..."
          
          # Node.js detection
          if [ -f "package.json" ]; then
            echo "has-nodejs=true" >> $GITHUB_OUTPUT
            echo "âœ… Node.js project detected"
          else
            echo "has-nodejs=false" >> $GITHUB_OUTPUT
          fi
          
          # Python detection
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ] || [ -f "setup.py" ]; then
            echo "has-python=true" >> $GITHUB_OUTPUT
            echo "âœ… Python project detected"
          else
            echo "has-python=false" >> $GITHUB_OUTPUT
          fi
          
          # Docker detection
          if find . -maxdepth 2 -name "Dockerfile*" -type f | grep -q .; then
            echo "has-docker=true" >> $GITHUB_OUTPUT
            echo "âœ… Docker project detected"
          else
            echo "has-docker=false" >> $GITHUB_OUTPUT
          fi
          
          # Test detection
          if find . -type f \( -name "*test*.py" -o -name "*test*.js" -o -name "*.test.ts" -o -name "*.spec.js" \) | grep -q .; then
            echo "has-tests=true" >> $GITHUB_OUTPUT
            echo "âœ… Tests detected"
          else
            echo "has-tests=false" >> $GITHUB_OUTPUT
          fi

  # ============================================================================
  # DOCUMENTATION CHECK
  # ============================================================================

  documentation-check:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check documentation structure
        run: |
          echo "ðŸ“š Validating documentation structure..."
          
          # Check if this is a personal dev branch
          if [[ "$GITHUB_REF" =~ -dev$ ]]; then
            echo "Personal dev branch detected"
            
            # Define recommended directories for personal branches
            REQUIRED_DIRS=("research" "planning" "process" "tools")
            MISSING_DIRS=()
            
            for dir in "${REQUIRED_DIRS[@]}"; do
              if [ ! -d "$dir" ]; then
                echo "â„¹ï¸  Recommended directory not found: $dir"
                MISSING_DIRS+=("$dir")
              else
                echo "âœ… Found $dir directory"
              fi
            done
            
            if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
              echo ""
              echo "ðŸ’¡ Note: Personal dev branches benefit from documentation in:"
              printf '   - %s\n' "${MISSING_DIRS[@]}"
              echo ""
              echo "This is a recommendation, not a failure."
            fi
          fi
          
          # Check for README
          if [ -f "README.md" ]; then
            echo "âœ… README.md found"
          else
            echo "â„¹ï¸  No README.md found - consider adding one"
          fi
          
          echo "Documentation check completed"

      - name: Validate markdown files
        run: |
          echo "Checking markdown files..."
          MD_COUNT=$(find . -name "*.md" -type f ! -path "./node_modules/*" ! -path "./.git/*" | wc -l)
          echo "Found $MD_COUNT markdown files"
          
          find . -name "*.md" -type f ! -path "./node_modules/*" ! -path "./.git/*" | while read file; do
            echo "Validating: $file"
            if [ ! -s "$file" ]; then
              echo "âš ï¸  Warning: $file is empty"
            fi
          done

      - name: Check commit message format
        if: github.event_name == 'pull_request'
        run: |
          echo "Validating commit message format..."
          git log --format=%s origin/${{ github.base_ref }}..${{ github.sha }} | while read msg; do
            if [[ "$msg" =~ ^(feat|fix|docs|style|refactor|test|chore|ci|perf): ]]; then
              echo "âœ… Valid: $msg"
            else
              echo "â„¹ï¸  Suggestion: Use conventional commits format (feat:, fix:, docs:, etc.)"
              echo "  Current: $msg"
            fi
          done

  # ============================================================================
  # NODE.JS QUALITY & TESTS
  # ============================================================================

  nodejs-checks:
    name: Node.js - Quality & Tests
    runs-on: ubuntu-latest
    needs: detect-project
    if: needs.detect-project.outputs.has-nodejs == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci || npm install

      - name: Run linting
        continue-on-error: true
        run: |
          if grep -q "\"lint\"" package.json; then
            npm run lint
          else
            echo "No lint script found, skipping"
          fi

      - name: Run tests
        continue-on-error: true
        run: |
          if grep -q "\"test\"" package.json; then
            npm test
          else
            echo "No test script found, skipping"
          fi

      - name: Build project
        continue-on-error: true
        run: |
          if grep -q "\"build\"" package.json; then
            npm run build
          else
            echo "No build script found, skipping"
          fi

  # ============================================================================
  # PYTHON QUALITY & TESTS
  # ============================================================================

  python-checks:
    name: Python - Quality & Tests
    runs-on: ubuntu-latest
    needs: detect-project
    if: needs.detect-project.outputs.has-python == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          if [ -f "requirements-dev.txt" ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Install linting tools
        run: |
          pip install flake8 black isort pylint || true

      - name: Run linting
        continue-on-error: true
        run: |
          echo "Running flake8..."
          flake8 . --exclude=venv,.venv,node_modules,.git --count --select=E9,F63,F7,F82 --show-source --statistics || true
          
          echo "Checking code formatting with black..."
          black --check . || echo "black check completed"
          
          echo "Checking import sorting with isort..."
          isort --check-only . || echo "isort check completed"

      - name: Run tests
        continue-on-error: true
        run: |
          pip install pytest pytest-cov || true
          if [ -d "tests" ] || find . -name "*test*.py" | grep -q .; then
            pytest --cov=. --cov-report=xml || echo "pytest completed"
          else
            echo "No tests found"
          fi

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        continue-on-error: true
        if: hashFiles('coverage.xml') != ''
        with:
          files: ./coverage.xml
          token: ${{ secrets.CODECOV_TOKEN }}

  # ============================================================================
  # SECURITY SCANNING
  # ============================================================================

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        continue-on-error: true
        run: |
          echo "ðŸ”’ Scanning for potential secrets..."
          FOUND=0
          
          git ls-files | while read file; do
            # Skip binary files and large files
            if file "$file" | grep -q text; then
              if grep -iE "(password|secret|api[_-]?key|token|credential).*[=:].*['\"]?[a-zA-Z0-9]{8,}" "$file" 2>/dev/null; then
                echo "âš ï¸  Potential secret pattern found in: $file"
                FOUND=1
              fi
            fi
          done
          
          if [ $FOUND -eq 0 ]; then
            echo "âœ… No obvious secrets detected"
          fi

  # ============================================================================
  # BUILD ARTIFACTS
  # ============================================================================

  build-artifacts:
    name: Build Artifacts
    runs-on: ubuntu-latest
    needs: [detect-project, nodejs-checks, python-checks]
    if: |
      always() &&
      (needs.nodejs-checks.result == 'success' || needs.nodejs-checks.result == 'skipped') &&
      (needs.python-checks.result == 'success' || needs.python-checks.result == 'skipped') &&
      (github.event_name == 'push' || github.event.pull_request.merged == true)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create artifact directory
        run: mkdir -p dist

      - name: Build Node.js artifacts
        if: needs.detect-project.outputs.has-nodejs == 'true'
        run: |
          echo "Building Node.js artifacts..."
          if [ -f "package.json" ]; then
            npm ci || npm install
            if grep -q "\"build\"" package.json; then
              npm run build || true
            fi
            
            # Copy build outputs
            if [ -d "build" ]; then
              cp -r build dist/
            elif [ -d "dist" ] && [ "$(ls -A dist 2>/dev/null)" ]; then
              cp -r dist/* dist/ 2>/dev/null || true
            fi
          fi

      - name: Build Python artifacts
        if: needs.detect-project.outputs.has-python == 'true'
        run: |
          echo "Building Python artifacts..."
          python -m pip install --upgrade pip build
          
          if [ -f "pyproject.toml" ]; then
            python -m build
            cp -r dist/*.whl dist/ 2>/dev/null || true
            cp -r dist/*.tar.gz dist/ 2>/dev/null || true
          fi
          
          # Create deployment package
          if [ -d "src" ]; then
            cp -r src dist/
          fi
          
          if [ -f "requirements.txt" ]; then
            cp requirements.txt dist/
          fi

      - name: Create artifact metadata
        run: |
          cat > dist/build-info.json <<EOF
          {
            "repository": "${GITHUB_REPOSITORY}",
            "branch": "${GITHUB_REF_NAME}",
            "commit": "${GITHUB_SHA}",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${GITHUB_ACTOR}",
            "run_id": "${GITHUB_RUN_ID}",
            "run_number": "${GITHUB_RUN_NUMBER}"
          }
          EOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: hashFiles('dist/**/*') != ''
        with:
          name: build-${{ github.sha }}
          path: dist/
          retention-days: 30

  # ============================================================================
  # PR SUMMARY
  # ============================================================================

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [documentation-check, nodejs-checks, python-checks, security-scan]
    if: github.event_name == 'pull_request' && always()
    permissions:
      pull-requests: write
    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const needs = ${{ toJSON(needs) }};
            
            // Calculate overall status
            let allSuccess = true;
            let statusLines = [];
            
            const jobs = {
              'Documentation': needs['documentation-check'],
              'Node.js Checks': needs['nodejs-checks'],
              'Python Checks': needs['python-checks'],
              'Security Scan': needs['security-scan']
            };
            
            for (const [name, job] of Object.entries(jobs)) {
              let emoji = 'â­ï¸';
              if (job.result === 'success') {
                emoji = 'âœ…';
              } else if (job.result === 'failure') {
                emoji = 'âŒ';
                allSuccess = false;
              } else if (job.result === 'skipped') {
                emoji = 'â­ï¸';
              }
              statusLines.push(`${emoji} ${name}`);
            }
            
            const statusEmoji = allSuccess ? 'âœ…' : 'âš ï¸';
            const statusText = allSuccess ? 'All checks passed!' : 'Some checks need attention';
            
            const body = `## ${statusEmoji} CI Pipeline Results
            
            ${statusText}
            
            ### Status
            ${statusLines.join('\n')}
            
            ---
            ðŸ“Š [View detailed results](${context.payload.pull_request.html_url}/checks)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
