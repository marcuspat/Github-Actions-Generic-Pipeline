name: Generic Dependency Management

# Auto-detects and manages dependencies for any project type
# Supports: npm, yarn, pnpm, pip, poetry, go mod, cargo, maven, gradle, bundler

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      auto_update:
        description: 'Automatically create PR with updates'
        required: false
        default: 'true'
        type: boolean
  push:
    paths:
      # Node.js
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      # Python
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'poetry.lock'
      - 'Pipfile.lock'
      # Go
      - 'go.mod'
      - 'go.sum'
      # Rust
      - 'Cargo.toml'
      - 'Cargo.lock'
      # Ruby
      - 'Gemfile'
      - 'Gemfile.lock'
      # Java
      - 'pom.xml'
      - 'build.gradle*'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  detect-dependencies:
    name: ðŸ” Detect Dependency Files
    runs-on: ubuntu-latest
    outputs:
      has-npm: ${{ steps.detect.outputs.has-npm }}
      has-yarn: ${{ steps.detect.outputs.has-yarn }}
      has-pnpm: ${{ steps.detect.outputs.has-pnpm }}
      has-pip: ${{ steps.detect.outputs.has-pip }}
      has-poetry: ${{ steps.detect.outputs.has-poetry }}
      has-pipenv: ${{ steps.detect.outputs.has-pipenv }}
      has-go: ${{ steps.detect.outputs.has-go }}
      has-cargo: ${{ steps.detect.outputs.has-cargo }}
      has-bundler: ${{ steps.detect.outputs.has-bundler }}
      has-maven: ${{ steps.detect.outputs.has-maven }}
      has-gradle: ${{ steps.detect.outputs.has-gradle }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package managers
        id: detect
        run: |
          # Node.js
          [ -f "package-lock.json" ] && echo "has-npm=true" >> $GITHUB_OUTPUT || echo "has-npm=false" >> $GITHUB_OUTPUT
          [ -f "yarn.lock" ] && echo "has-yarn=true" >> $GITHUB_OUTPUT || echo "has-yarn=false" >> $GITHUB_OUTPUT
          [ -f "pnpm-lock.yaml" ] && echo "has-pnpm=true" >> $GITHUB_OUTPUT || echo "has-pnpm=false" >> $GITHUB_OUTPUT
          
          # Python
          [ -f "requirements.txt" ] && echo "has-pip=true" >> $GITHUB_OUTPUT || echo "has-pip=false" >> $GITHUB_OUTPUT
          [ -f "poetry.lock" ] && echo "has-poetry=true" >> $GITHUB_OUTPUT || echo "has-poetry=false" >> $GITHUB_OUTPUT
          [ -f "Pipfile.lock" ] && echo "has-pipenv=true" >> $GITHUB_OUTPUT || echo "has-pipenv=false" >> $GITHUB_OUTPUT
          
          # Go
          [ -f "go.mod" ] && echo "has-go=true" >> $GITHUB_OUTPUT || echo "has-go=false" >> $GITHUB_OUTPUT
          
          # Rust
          [ -f "Cargo.toml" ] && echo "has-cargo=true" >> $GITHUB_OUTPUT || echo "has-cargo=false" >> $GITHUB_OUTPUT
          
          # Ruby
          [ -f "Gemfile" ] && echo "has-bundler=true" >> $GITHUB_OUTPUT || echo "has-bundler=false" >> $GITHUB_OUTPUT
          
          # Java
          [ -f "pom.xml" ] && echo "has-maven=true" >> $GITHUB_OUTPUT || echo "has-maven=false" >> $GITHUB_OUTPUT
          [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] && echo "has-gradle=true" >> $GITHUB_OUTPUT || echo "has-gradle=false" >> $GITHUB_OUTPUT

  check-outdated:
    name: ðŸ“¦ Check Outdated Dependencies
    runs-on: ubuntu-latest
    needs: detect-dependencies
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js - NPM
      - name: Check NPM outdated
        if: needs.detect-dependencies.outputs.has-npm == 'true'
        run: |
          echo "## ðŸ“¦ NPM Dependencies" >> $GITHUB_STEP_SUMMARY
          npm outdated --long || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Node.js - Yarn
      - name: Check Yarn outdated
        if: needs.detect-dependencies.outputs.has-yarn == 'true'
        run: |
          echo "## ðŸ§¶ Yarn Dependencies" >> $GITHUB_STEP_SUMMARY
          yarn outdated || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Node.js - pnpm
      - name: Check pnpm outdated
        if: needs.detect-dependencies.outputs.has-pnpm == 'true'
        run: |
          npm install -g pnpm
          echo "## ðŸ“¦ pnpm Dependencies" >> $GITHUB_STEP_SUMMARY
          pnpm outdated || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Python - pip
      - name: Check pip outdated
        if: needs.detect-dependencies.outputs.has-pip == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt 2>/dev/null || true
          echo "## ðŸ Python Dependencies" >> $GITHUB_STEP_SUMMARY
          pip list --outdated || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Python - Poetry
      - name: Check Poetry outdated
        if: needs.detect-dependencies.outputs.has-poetry == 'true'
        run: |
          pip install poetry
          echo "## ðŸ“œ Poetry Dependencies" >> $GITHUB_STEP_SUMMARY
          poetry show --outdated || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Go
      - name: Check Go outdated
        if: needs.detect-dependencies.outputs.has-go == 'true'
        run: |
          echo "## ðŸ¹ Go Dependencies" >> $GITHUB_STEP_SUMMARY
          go list -u -m all || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Rust
      - name: Check Cargo outdated
        if: needs.detect-dependencies.outputs.has-cargo == 'true'
        run: |
          cargo install cargo-outdated || true
          echo "## ðŸ¦€ Rust Dependencies" >> $GITHUB_STEP_SUMMARY
          cargo outdated || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

      # Ruby
      - name: Check Bundler outdated
        if: needs.detect-dependencies.outputs.has-bundler == 'true'
        run: |
          bundle install
          echo "## ðŸ’Ž Ruby Dependencies" >> $GITHUB_STEP_SUMMARY
          bundle outdated || echo "All gems up to date" >> $GITHUB_STEP_SUMMARY

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    needs: detect-dependencies
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Node.js audit
      - name: NPM audit
        if: needs.detect-dependencies.outputs.has-npm == 'true'
        continue-on-error: true
        run: |
          echo "## ðŸ”’ NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          npm audit --json > npm-audit.json || true
          
          if [ -f "npm-audit.json" ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json)
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json)
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json)
            LOW=$(jq '.metadata.vulnerabilities.low // 0' npm-audit.json)
            
            echo "- ðŸ”´ Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ  High: $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¡ Moderate: $MODERATE" >> $GITHUB_STEP_SUMMARY
            echo "- ðŸŸ¢ Low: $LOW" >> $GITHUB_STEP_SUMMARY
          fi

      # Python audit
      - name: Python safety check
        if: needs.detect-dependencies.outputs.has-pip == 'true'
        continue-on-error: true
        run: |
          pip install safety
          echo "## ðŸ”’ Python Security Audit" >> $GITHUB_STEP_SUMMARY
          safety check --json > safety-report.json || true
          
          if [ -f "safety-report.json" ]; then
            VULN_COUNT=$(jq 'length' safety-report.json 2>/dev/null || echo "0")
            echo "Found $VULN_COUNT vulnerabilities" >> $GITHUB_STEP_SUMMARY
          fi

      # Go audit
      - name: Go vulnerability check
        if: needs.detect-dependencies.outputs.has-go == 'true'
        continue-on-error: true
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          echo "## ðŸ”’ Go Security Audit" >> $GITHUB_STEP_SUMMARY
          govulncheck ./... || echo "Security check complete" >> $GITHUB_STEP_SUMMARY

      # Rust audit
      - name: Cargo audit
        if: needs.detect-dependencies.outputs.has-cargo == 'true'
        continue-on-error: true
        run: |
          cargo install cargo-audit || true
          echo "## ðŸ”’ Rust Security Audit" >> $GITHUB_STEP_SUMMARY
          cargo audit || echo "Security check complete" >> $GITHUB_STEP_SUMMARY

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports-${{ github.sha }}
          path: |
            npm-audit.json
            safety-report.json
          retention-days: 30

  auto-update:
    name: ðŸ”„ Auto-update Dependencies
    runs-on: ubuntu-latest
    needs: [detect-dependencies, check-outdated, security-audit]
    if: |
      (github.event_name == 'schedule' || 
       github.event.inputs.auto_update == 'true') &&
      github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Update Node.js dependencies
      - name: Update NPM dependencies
        if: needs.detect-dependencies.outputs.has-npm == 'true'
        run: |
          npm update
          npm audit fix --force || true

      - name: Update Yarn dependencies
        if: needs.detect-dependencies.outputs.has-yarn == 'true'
        run: |
          yarn upgrade
          yarn audit fix || true

      - name: Update pnpm dependencies
        if: needs.detect-dependencies.outputs.has-pnpm == 'true'
        run: |
          npm install -g pnpm
          pnpm update
          pnpm audit fix || true

      # Update Python dependencies
      - name: Update pip dependencies
        if: needs.detect-dependencies.outputs.has-pip == 'true'
        continue-on-error: true
        run: |
          pip install pip-tools || true
          pip-compile --upgrade requirements.in -o requirements.txt 2>/dev/null || true

      - name: Update Poetry dependencies
        if: needs.detect-dependencies.outputs.has-poetry == 'true'
        run: |
          pip install poetry
          poetry update || true

      # Update Go dependencies
      - name: Update Go dependencies
        if: needs.detect-dependencies.outputs.has-go == 'true'
        run: |
          go get -u ./...
          go mod tidy

      # Update Rust dependencies
      - name: Update Cargo dependencies
        if: needs.detect-dependencies.outputs.has-cargo == 'true'
        run: |
          cargo update

      # Update Ruby dependencies
      - name: Update Bundler dependencies
        if: needs.detect-dependencies.outputs.has-bundler == 'true'
        run: |
          bundle update

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'ðŸ”„ Automated Dependency Updates'
          body: |
            ## ðŸ¤– Automated Dependency Update
            
            This PR contains automated dependency updates across all package managers.
            
            ### ðŸ“¦ Updated Dependencies
            Review the files changed to see what was updated.
            
            ### âœ… Checks Performed
            - [x] Outdated packages identified
            - [x] Security vulnerabilities checked
            - [x] Updates applied
            
            ### âš ï¸ Before Merging
            - [ ] Review changelog for breaking changes
            - [ ] Verify all tests pass
            - [ ] Test locally if needed
            
            ---
            *Auto-generated on $(date)*
          branch: chore/dependency-updates-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            security

  summary:
    name: ðŸ“Š Summary Report
    runs-on: ubuntu-latest
    needs: [detect-dependencies, check-outdated, security-audit]
    if: always()
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          # ðŸ“¦ Dependency Management Report
          
          ## ðŸ” Detected Package Managers
          | Package Manager | Status |
          |-----------------|--------|
          | NPM | ${{ needs.detect-dependencies.outputs.has-npm == 'true' && 'âœ…' || 'âŒ' }} |
          | Yarn | ${{ needs.detect-dependencies.outputs.has-yarn == 'true' && 'âœ…' || 'âŒ' }} |
          | pnpm | ${{ needs.detect-dependencies.outputs.has-pnpm == 'true' && 'âœ…' || 'âŒ' }} |
          | pip | ${{ needs.detect-dependencies.outputs.has-pip == 'true' && 'âœ…' || 'âŒ' }} |
          | Poetry | ${{ needs.detect-dependencies.outputs.has-poetry == 'true' && 'âœ…' || 'âŒ' }} |
          | Pipenv | ${{ needs.detect-dependencies.outputs.has-pipenv == 'true' && 'âœ…' || 'âŒ' }} |
          | Go | ${{ needs.detect-dependencies.outputs.has-go == 'true' && 'âœ…' || 'âŒ' }} |
          | Cargo | ${{ needs.detect-dependencies.outputs.has-cargo == 'true' && 'âœ…' || 'âŒ' }} |
          | Bundler | ${{ needs.detect-dependencies.outputs.has-bundler == 'true' && 'âœ…' || 'âŒ' }} |
          | Maven | ${{ needs.detect-dependencies.outputs.has-maven == 'true' && 'âœ…' || 'âŒ' }} |
          | Gradle | ${{ needs.detect-dependencies.outputs.has-gradle == 'true' && 'âœ…' || 'âŒ' }} |
          
          ## ðŸ“Š Job Status
          - Check Outdated: ${{ needs.check-outdated.result }}
          - Security Audit: ${{ needs.security-audit.result }}
          
          ---
          *Generated by Generic Dependency Management*
          EOF
