name: Branch Management

on:
  create:
  push:
    branches:
      - '**-dev'
  pull_request:
    types: [opened, reopened]
    branches:
      - main
      - develop

jobs:
  validate-branch-name:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'create' || github.event_name == 'push'
    steps:
      - name: Check branch naming convention
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Checking branch: $BRANCH_NAME"
          
          # Valid patterns: main, develop, feature/*, bugfix/*, hotfix/*, [name]-dev
          if [[ "$BRANCH_NAME" =~ ^(main|develop)$ ]] || \
             [[ "$BRANCH_NAME" =~ ^(feature|bugfix|hotfix)/.+ ]] || \
             [[ "$BRANCH_NAME" =~ ^.+-dev$ ]]; then
            echo "âœ… Valid branch name: $BRANCH_NAME"
          else
            echo "âš ï¸  Branch name doesn't follow convention"
            echo "Recommended patterns:"
            echo "  - Personal dev branch: [your-name]-dev"
            echo "  - Feature branch: feature/[description]"
            echo "  - Bug fix: bugfix/[description]"
            echo "  - Hot fix: hotfix/[description]"
          fi

  setup-personal-branch:
    name: Setup Personal Dev Branch
    runs-on: ubuntu-latest
    if: github.event_name == 'create' && endsWith(github.ref, '-dev')
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Create branch structure
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Setting up structure for personal branch: $BRANCH_NAME"
          
          # Create recommended directory structure
          mkdir -p research planning process tools src
          
          # Create template files if they don't exist
          if [ ! -f "research/README.md" ]; then
            cat > research/README.md <<EOF
          # Research Documentation
          
          ## Overview
          Document your research findings and investigations here.
          
          ## Topics
          - Technology evaluations
          - Architecture research
          - Competitive analysis
          - Best practices
          
          ## Template
          For each research topic, create a new document with:
          - Overview
          - Findings
          - Options evaluated
          - Recommendations
          - References
          EOF
          fi
          
          if [ ! -f "planning/README.md" ]; then
            cat > planning/README.md <<EOF
          # Planning Documentation
          
          ## Overview
          Document your implementation plans and specifications.
          
          ## Contents
          - Feature specifications
          - Technical designs
          - Implementation roadmaps
          - Timeline and milestones
          
          ## Before You Code
          Make sure to document:
          - What you're building
          - Why this approach
          - How you'll build it
          - Expected outcomes
          EOF
          fi
          
          if [ ! -f "process/README.md" ]; then
            cat > process/README.md <<EOF
          # Process Documentation
          
          ## Overview
          Document your development methodology and workflow.
          
          ## Contents
          - Development process
          - Testing strategy
          - Code review guidelines
          - Workflow steps
          
          ## Best Practices
          - Document decisions and rationale
          - Keep process documentation updated
          - Share learnings with the team
          EOF
          fi
          
          if [ ! -f "tools/README.md" ]; then
            cat > tools/README.md <<EOF
          # Tools & Frameworks
          
          ## Development Tools
          List and document the tools you're using:
          - Tool name
          - Purpose
          - Version
          - Configuration
          - Documentation links
          
          ## Libraries & Frameworks
          Document each dependency with:
          - Name and version
          - Purpose in the project
          - Why it was chosen
          - Key features being used
          
          ## Development Environment
          - Setup requirements
          - Installation steps
          - Configuration needed
          - Environment variables
          EOF
          fi
          
          # Create a welcome message
          cat > WELCOME.md <<EOF
          # Welcome to Your Development Branch! ðŸŽ‰
          
          Branch: \`$BRANCH_NAME\`
          Created: $(date)
          
          ## Next Steps
          
          ### 1. Document First, Code Second
          Before writing any code, document your approach:
          
          - \`research/\` - Your research and findings
          - \`planning/\` - Your implementation plans
          - \`process/\` - Your development workflow
          - \`tools/\` - Tools and frameworks you'll use
          
          ### 2. Commit Your Documentation
          \`\`\`bash
          git add research/ planning/ process/ tools/
          git commit -m "docs: Initial documentation structure"
          git push origin $BRANCH_NAME
          \`\`\`
          
          ### 3. Start Developing
          Once your documentation is committed, proceed with implementation in the \`src/\` directory.
          
          ### 4. Collaborate
          - Browse other team members' branches for reference
          - Create issues for discussions
          - Share your learnings
          
          ## Resources
          - [Main README](../README.md)
          - [Contribution Guidelines](../CONTRIBUTING.md)
          - Team collaboration channels
          
          Happy coding! ðŸš€
          EOF

      - name: Commit structure (if new)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "chore: Initialize personal dev branch structure"
            git push origin ${GITHUB_REF#refs/heads/}
            echo "âœ… Branch structure initialized"
          else
            echo "â„¹ï¸  Branch structure already exists"
          fi

  branch-summary:
    name: Generate Branch Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && endsWith(github.ref, '-dev')
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate branch statistics
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          echo "## ðŸ“Š Branch Statistics for $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count files by type
          echo "### ðŸ“ File Counts" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation (*.md): $(find . -name "*.md" -not -path "./.git/*" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- Python (*.py): $(find . -name "*.py" -not -path "./.git/*" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- JavaScript (*.js): $(find . -name "*.js" -not -path "./.git/*" -not -path "./node_modules/*" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "- TypeScript (*.ts): $(find . -name "*.ts" -not -path "./.git/*" -not -path "./node_modules/*" | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Directory structure
          echo "### ðŸ“‚ Directory Structure" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          tree -L 2 -d --noreport -I 'node_modules|.git|__pycache__|.venv' || find . -type d -not -path "./.git/*" -not -path "./node_modules/*" -maxdepth 2 | head -20
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Recent commits
          echo "### ðŸ“ Recent Activity" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git log --oneline -10 || echo "No commits yet"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  documentation-coverage:
    name: Documentation Coverage Report
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && endsWith(github.ref, '-dev')
    steps:
      - name: Checkout branch
        uses: actions/checkout@v4

      - name: Check documentation coverage
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          
          echo "## ðŸ“š Documentation Coverage for $BRANCH_NAME" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for required directories
          DIRS=("research" "planning" "process" "tools")
          SCORE=0
          
          for dir in "${DIRS[@]}"; do
            if [ -d "$dir" ]; then
              FILE_COUNT=$(find "$dir" -name "*.md" | wc -l)
              if [ $FILE_COUNT -gt 0 ]; then
                echo "- âœ… $dir/ ($FILE_COUNT docs)" >> $GITHUB_STEP_SUMMARY
                ((SCORE++))
              else
                echo "- âš ï¸  $dir/ (empty)" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- âŒ $dir/ (missing)" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          PERCENTAGE=$((SCORE * 25))
          echo "**Documentation Score: $PERCENTAGE% ($SCORE/4 sections)**" >> $GITHUB_STEP_SUMMARY
          
          if [ $SCORE -eq 4 ]; then
            echo "ðŸŽ‰ Excellent! All documentation sections present." >> $GITHUB_STEP_SUMMARY
          elif [ $SCORE -ge 2 ]; then
            echo "ðŸ‘ Good progress! Consider adding more documentation." >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“ Tip: Add documentation in research/, planning/, process/, and tools/ directories." >> $GITHUB_STEP_SUMMARY
          fi

  pr-readiness-check:
    name: PR Readiness Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR requirements
        run: |
          echo "## ðŸ” PR Readiness Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          READY=true
          
          # Check for documentation
          if [ -d "research" ] && [ "$(find research -name '*.md' | wc -l)" -gt 0 ]; then
            echo "- âœ… Research documentation present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Research documentation missing" >> $GITHUB_STEP_SUMMARY
            READY=false
          fi
          
          # Check for tests
          if find . -name "*test*.py" -o -name "*test*.js" -o -name "*.test.ts" | grep -q .; then
            echo "- âœ… Tests found" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸  No tests found" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check commit messages
          CONVENTIONAL_COMMITS=$(git log origin/${{ github.base_ref }}..${{ github.sha }} --format=%s | grep -cE '^(feat|fix|docs|style|refactor|test|chore|ci|perf):' || echo 0)
          TOTAL_COMMITS=$(git log origin/${{ github.base_ref }}..${{ github.sha }} --format=%s | wc -l)
          
          if [ $CONVENTIONAL_COMMITS -gt 0 ]; then
            echo "- âœ… Using conventional commit format ($CONVENTIONAL_COMMITS/$TOTAL_COMMITS commits)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â„¹ï¸  Consider using conventional commit format" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check PR description
          if [ -n "${{ github.event.pull_request.body }}" ]; then
            echo "- âœ… PR description provided" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸  PR description is empty" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$READY" = true ]; then
            echo "âœ… **PR looks good!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **Please address the items above before merging.**" >> $GITHUB_STEP_SUMMARY
          fi
